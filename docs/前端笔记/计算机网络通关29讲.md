# 计算机网络通关 29 讲

> 本文由阅读《[计算机网络通关 29 讲)](https://kaiwu.lagou.com/course/courseInfo.htm?courseId=837#/detail/pc?id=7267))》记录笔记，有兴趣可阅读原版教程。



## 传输层协议 TCP

### TCP 协议

**TCP（Transport Control Protocol）是一个传输层协议，提供 Host-To-Host 数据的可靠传输，支持全双工，是一个连接导向的协议。**



### 主机到主机（Host-To-Host）

**TCP 提供的是 Host-To-Host 传输，一台主机通过 TCP 发送数据给另一台主机**。这里的主机（Host）是一个抽象的概念，可以是手机、平板、手表等。收发数据的设备都是主机，所以双方是平等的。

![image-20220818144749540](https://blog-picgo-typora.oss-cn-hangzhou.aliyuncs.com/image-20220818144749540.png)



**TCP 协议往上是应用到应用（Application-To-Application）的协议。**什么是应用到应用的协议呢？比如你用微信发信息给张三，你的微信客户端、微信聊天服务都是应用。微信有自己的聊天协议，微信的聊天协议是应用到应用的协议；如果微信的聊天协议想要工作，就需要一个主机到主机的协议帮助它实现通信。



而 TCP 上层有太多的应用，不仅仅有微信，还有原神、抖音、网易云音乐……因此 TCP 上层的应用层协议使用 TCP 能力的时候，需要告知 TCP 是哪个应用——这就是**==端口号。端口号用于区分应用==**，下文中我们还会详细讨论。



TCP 要实现主机到主机通信，就需要知道主机们的**网络地址（IP 地址）**，但是 TCP 不负责实际地址到地址（Address-To-Address）的传输，因此 TCP 协议把 IP 地址给底层的互联网层处理。



**互联网层，也叫网络层（Network Layer），提供地址到地址的通信**，IP 协议就在这一层工作。**互联网层解决地址到地址的通信，但是不负责信号在具体两个设备间传递**。因此，**网络层会调用下方的==链路层==在两个相邻设备间传递信息**。当信号在两个设备间传递的时候，科学家又设计出了**物理层封装最底层的物理设备、传输介质**等，由最下方的**物理层提供最底层的传输能力**。



以上的 5 层架构，我们称为**互联网协议群**，也称作 **TCP/IP 协议群**。总结下，**主机到主机（Host-To-Host）为应用提供应用间通信的能力。**



### 什么是连接和会话？

连接是通信双方的一个约定，目标是让两个在通信的程序之间产生一个默契，保证两个程序都在线，而且尽快地响应对方的请求，这就是**连接（Connection）**。

设计上，连接是一种传输数据的行为。传输之前，建立一个连接。具体来说，数据收发双方的内存中都建立一个用于维护数据传输状态的对象，比如双方 IP 和端口是多少？现在发送了多少数据了？状态健康吗？传输速度如何？等。所以，**连接是网络行为状态的记录。**

和连接关联的还有一个名词，叫作会话（Session），**会话是应用的行为**。比如微信里张三和你聊天，那么张三和你建立一个会话。你要和张三聊天，你们创建一个聊天窗口，这个就是会话。

**会话是应用层的概念，连接是传输层的概念。**



### 双工/单工问题

在任何一个时刻，如果数据只能单向发送，就是**单工**，所以单工需要至少一条线路。如果在某个时刻数据可以向一个方向传输，也可以向另一个方向反方向传输，而且交替进行，叫作**半双工**；半双工需要至少 1 条线路。最后，如果任何时刻数据都可以双向收发，这就是**全双工**，全双工需要大于 1 条线路。当然这里的线路，是一个抽象概念，你可以并发地处理信号，达到模拟双工的目的。

**TCP 是一个双工协议，数据任何时候都可以双向传输**。这就意味着客户端和服务端可以平等地发送、接收信息。正因为如此，客户端和服务端在 TCP 协议中有一个平等的名词——**Host（主机）**。



### 什么是可靠性？

**可靠性指数据保证无损传输。**如果发送方按照顺序发送，然后数据无序地在网络间传递，就必须有一种算法在接收方将数据恢复原有的顺序。



### 建立连接的过程（三次握手）

因为要保持连接和可靠性约束，TCP 协议要保证每一条发出的数据必须给返回，返回数据叫作 ACK（也就是响应）。

![image-20221205112501035](https://blog-picgo-typora.oss-cn-hangzhou.aliyuncs.com/image-20221205112501035.png)



### 断开连接的过程（4 次挥手）

1. 端要求断开连接，发送一个断开的请求，这个叫作（FIN）。

2. 服务端收到请求，然后给客户端一个 ACK，作为 FIN 的响应。

3. 这里你需要思考一个问题，可不可以像握手那样马上传 FIN 回去？
   其实这个时候服务端不能马上传 FIN，因为断开连接要处理的问题比较多，比如说服务端可能还有发送出去的消息没有得到 ACK；也有可能服务端自己有资源要释放。因此断开连接不能像握手那样操作——将两条消息合并。所以，服务端经过一个等待，确定可以关闭连接了，再发一条 FIN 给客户端。

4. 客户端收到服务端的 FIN，同时客户端也可能有自己的事情需要处理完，比如客户端有发送给服务端没有收到 ACK 的请求，客户端自己处理完成后，再给服务端发送一个 ACK。

![image-20221205115252561](https://blog-picgo-typora.oss-cn-hangzhou.aliyuncs.com/image-20221205115252561.png)



## TCP 的封包格式

### TCP 的拆包和粘包

TCP 是一个传输层协议。TCP 发送数据的时候，往往不会将数据一次性发送，像下图这样：

![image-20221205141107908](https://blog-picgo-typora.oss-cn-hangzhou.aliyuncs.com/image-20221205141107908.png)

而是将数据拆分成很多个部分，然后再逐个发送。像下图这样：

![image-20221205141125366](https://blog-picgo-typora.oss-cn-hangzhou.aliyuncs.com/image-20221205141125366.png)

同样的，在目的地，TCP 协议又需要逐个接收数据。请你思考，**TCP 为什么不一次发送完所有的数据？**



这里有很多原因，比如为了稳定性，一次发送的数据越多，出错的概率越大。再比如说为了效率，网络中有时候存在着并行的路径，拆分数据包就能更好地利用这些并行的路径。再有，比如发送和接收数据的时候，都存在着缓冲区。如下图所示：

![image-20221205141554015](https://blog-picgo-typora.oss-cn-hangzhou.aliyuncs.com/image-20221205141554015.png)



缓冲区是在内存中开辟的一块区域，目的是缓冲。因为大量的应用频繁地通过网卡收发数据，这个时候，网卡只能一个一个处理应用的请求。当网卡忙不过来的时候，数据就需要排队，也就是将数据放入缓冲区。如果每个应用都随意发送很大的数据，可能导致其他应用实时性遭到破坏。

总之，方方面面的原因：**在传输层封包不能太大**。这种限制，往往是以缓冲区大小为单位的。也就是 TCP 协议，会将数据拆分成不超过缓冲区大小的一个个部分。每个部分有一个独特的名词，叫作 **TCP 段（TCP Segment）**。

在接收数据的时候，一个个 TCP 段又被重组成原来的数据。

像这样，数据经过拆分，然后传输，然后在目的地重组，俗称**拆包**。所以拆包是将数据拆分成多个 TCP 段传输。

那么粘包是什么呢？有时候，如果发往一个目的地的多个数据太小了，为了防止多次发送占用资源，TCP 协议有可能将它们合并成一个 TCP 段发送，在目的地再还原成多个数据，这个过程俗称**粘包**。所以粘包是将多个数据合并成一个 TCP 段发送。
